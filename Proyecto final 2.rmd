---
title: "Trabajo Final"
output: pdf_document
date: "2024-05-23"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

 
# Introducción

Airbnb es una compañía dedicada a la oferta de alojamientos de carácter vacacional en muchos de los países del mundo. Esta funciona a partir de un programa digital donde los anfitriones pueden publicar sus propiedades para que los clientes puedan verlas y elegir el alojamiento que más se adapte a sus necesidades. 

En este proyecto se trabajó con algunas propiedades de Barcelona y la motivación inicial de su realización era estimar el precio en euros de diferentes apartamentos según las características de cada uno. Para realizar lo mencionado se trabajó con los datos de Airbnb Barcelona, donde se tenía el registro de más de 16.000 apartamentos de dicha ciudad. 

La información con la que se contaba era buena pero excesiva, lo que llevó a que algunos datos fueran redundantes, por lo cual una parte importante de este proyecto fue la inicial, donde se realizó una limpieza de datos para así disponer de información que permita realizar una buena estimación e interpretación de los datos. 

Finalmente, el trabajo e interpretación de los datos, tanto sobre como actúan entre si y sus diversos efectos sobre la variable de interés fueron los que guiaron y generaron el interés en este proyecto provocando que el paso a paso sea tan importante como el resultado final.  

  

```{r ,echo=FALSE,warning=FALSE}
#install.packages("codpostal")
library(here)
library(readxl)
library(tidyverse)
library(ggplot2)
library(visdat)
library(patchwork)
library(car)
library(qqplotr)
```

```{r}
df = read_excel(here("airbnb_barcelona_v2.xlsx"))

head(df)
summary(df)
```



```{r}

#Los datos: 

#Como se mencionó anteriormente, se disponía de la información de 16.761 apartamentos de Barcelona, donde se nombraban las características que los huéspedes toman en cuenta al momento de elegir su hospedaje y por lo tanto podrían llegar a incidir en su precio, entre estas se destacaba, ubicación, cantidad de camas y baños, cuantas personas se aceptaban, entre otras. 

#Habían variables cuantitativas pero la mayoría eran cualitativas, e incluso se pasaron a factor algunas de las cuantitativas para su mejor interpretación. 

#La información de código postal y barrio se decidió resumirla en una variable llamada distrito la cual agrupó los 73 barrios de Barcelona en 10 distritos.  

#Se decidió prescindir de la latitud y longitud de cada apartamento como de algunas variables que #se encontraban dentro de la variable amenities, tomando en cuenta finalmente las diez más #importantes. 

#Del total de observaciones se operó con – debido a que las restantes contaban con datos faltantes.   

#Finalizada la limpieza y organización de datos se pudo comenzar a trabajar con ellos. 

df%>%vis_miss()

df= df %>% select(barrio,
                  tipo_habitacion,
                  personas,
                  banios,
                  habitaciones,
                  camas,
                  precio_euros,	
                  estancia_min,	
                  puntuacion,	 
                  TV,	 
                  Wifi,	
                  Air_conditioning,	
                  Elevator,	
                  Breakfast,	
                  Pets_allowed,	
                 # Cable_TV,	
                  Pool,	
                  Patio_or_balcony,	
                  check_in_24_hs,	
                  Smart_lock)%>% filter(is.na(puntuacion)==FALSE,
                                        is.na(barrio)==FALSE,
                                        is.na(banios)==FALSE,
                                        is.na(habitaciones)==FALSE,
                                        is.na(camas)==FALSE
                                        )

df%>%vis_miss()
#df%>% summarise(sum_wifi=sum(Wifi),sum_int=sum(Internet))

```



```{r}

distritos<-character(length(nrow(df)))


#CON AYUDA, primero hay que sacar las observaciones que no tienen el dato del barrio para que funcione el codigo
  
for (i in seq_along(df$barrio)) {
    if (df$barrio[i] == "Sant Marta"|| 
               df$barrio[i] == "La Guineueta - Canyelles"|| 
               df$barrio[i] == "La Prosperitat"|| 
               df$barrio[i] == "Nou Barris"|| 
               df$barrio[i] == "Porta"|| 
               df$barrio[i] == "Trinitat Nova"|| 
               df$barrio[i] == "Turo de la Peira - Can Peguera"|| 
               df$barrio[i] == "Verdum - Los Roquetes"|| 
               df$barrio[i] == "Vilapicina i la Torre Llobeta") {
      distritos[i] <- "Nou Barris"
    } else if (df$barrio[i]=='La Sagrada Familia' || 
               df$barrio[i] == "Eixample" || 
               df$barrio[i] == "L'Antiga Esquerra de l'Eixample" || 
               df$barrio[i] == "Sant Antoni" || 
               df$barrio[i] == "Dreta de l'Eixample" || 
               df$barrio[i] == "La Nova Esquerra de l'Eixample" || 
               df$barrio[i] == "el Fort Pienc") {
      distritos[i] <- "L'Eixample"
    } else if (df$barrio[i] == "Vila de Gracia" || 
               df$barrio[i] == "Camp d'en Grassot i Gracia Nova" || 
               df$barrio[i] == "Gracia" || 
               df$barrio[i] == "El Coll" || 
               df$barrio[i] == "La Salut" || 
               df$barrio[i] == "Vallcarca i els Penitents") {
      distritos[i] <- "Gracia"
    } else if (df$barrio[i] == "Horta-Guinarda" ||
               df$barrio[i] == "Can Baro" ||
               df$barrio[i] == "Carmel" ||
               df$barrio[i] == "El Baix Guinardo"||
               df$barrio[i] == "Guinarda" ||
               df$barrio[i] == "Horta"||
               df$barrio[i] == "La Font d'en Fargues"||
               df$barrio[i] == "La Teixonera"||
               df$barrio[i] == "La Vall d'Hebron"||
               df$barrio[i] == "Montbau"||
               df$barrio[i] == "Sant Geni­s dels Agudells") {
      distritos[i] <- "Horta"
    } else if (df$barrio[i] == "Les Corts"|| 
               df$barrio[i] == "La Maternitat i Sant Ramon"|| 
               df$barrio[i] == "Pedralbes") {
      distritos[i] <- "Les Corts"
    } else if (df$barrio[i] == "El Gotic" || 
               df$barrio[i] == "La Barceloneta" || 
               df$barrio[i] == "Ciutat Vella" || 
               df$barrio[i] == "El Raval" || 
               df$barrio[i] == "Sant Pere/Santa Caterina" || 
               df$barrio[i] == "El Born") {
      distritos[i] <- "Ciutat Vella"
    } else if (df$barrio[i] == "El Poble-sec" || 
               df$barrio[i] == "Sants-Montjuic") {
      distritos[i] <- "Sants-Montjuic"
    } else if (df$barrio[i] == "El Clot" || 
               df$barrio[i] == "El Besos i el Maresme" || 
               df$barrio[i] == "El Camp de l'Arpa del Clot"||
               df$barrio[i] == "El Poblenou"||
               df$barrio[i] == "La Vila Olimpica"||
               df$barrio[i] == "Diagonal Mar - La Mar Bella"||
               df$barrio[i] == "Glaries - El Parc"||
               df$barrio[i] == "La Verneda i La Pau"||
               df$barrio[i] == "Provencals del Poblenou"||
               df$barrio[i] == "Sant Marta­ de Provencals"
               ) {
      distritos[i] <- "Sant Martí"
    } else if (df$barrio[i] == "Sant Gervasi - Galvany"||
               df$barrio[i] == "El Putget i Farro"||
               df$barrio[i] == "Les Tres Torres"||
               df$barrio[i] == "Sant Gervasi - la Bonanova"||
               df$barrio[i] == "Sarria"||
               df$barrio[i] == "Sarria-Sant Gervasi") {
      distritos[i] <- "Sarriá"
    } else if (df$barrio[i] == "El Bon Pastor" ||
               df$barrio[i] == "El Congres i els Indians"||
               df$barrio[i] == "La Sagrera"||
               df$barrio[i] == "La Trinitat Vella"||
               df$barrio[i] == "Navas"||
               df$barrio[i] == "Sant Andreu"||
               df$barrio[i] == "Sant Andreu de Palomar") {
      distritos[i] <- "Sant Andreau"
  }
}
df$distritos <- distritos

```



```{r}

summary(df)

df_final= df%>% mutate(tipo_habitacion=as.factor(tipo_habitacion),
                       banios=as.factor(banios),
                       camas=as.factor(camas),
                       habitaciones=as.factor(habitaciones),
                       distritos=as.factor(distritos),
                       wifi=as.factor(Wifi),
                      TV=as.factor(TV),	 
                  Wifi=as.factor(wifi),	
                  Air_conditioning=as.factor(Air_conditioning),	
                  Elevator=as.factor(Elevator),	
                  Breakfast=as.factor(Breakfast),	
                  Pets_allowed=as.factor(Pets_allowed),	
                 # Cable_TV=as.factor(Cable_TV),	
                  Pool=as.factor(Pool),	
                  Patio_or_balcony=as.factor(Patio_or_balcony),	
                  check_in_24_hs=as.factor(check_in_24_hs),	
                  Smart_lock=as.factor(Smart_lock)
             )

```


```{r, echo=FALSE,warning=FALSE}

#Como parte de la estadística descriptiva se crearon gráficos donde se relacionan cada una de las variables explicativas con la variable de respuesta (precio en euros), estos graficos permiten obtener interpretaciones de las diferentes relaciones, pero es muy importante destacar que las interpretaciones obtenidas son parciales, debido a que a diferencia del modelo, en cada uno de los gráficos se representa el efecto de una variable sin tomar en cuenta las demás.

#ggplot(data=df_final) + geom_boxplot(aes(x=tipo_habitacion,y=precio_euros,fill=tipo_habitacion)) + ylab('Precio (en Euros)')+ xlab("Tipo de Habitación")

#p2=ggplot(data=df_final) + geom_point(aes(x=personas,y=precio_euros),size=0.25) + theme (axis.title.y = element_blank())

#p3=ggplot(data=df_final) + geom_point(aes(x=estancia_min,y=precio_euros),size=0.25) + theme (axis.title.y = element_blank())

#ggplot(data=df_final) + geom_point(aes(x=puntuacion,y=precio_euros)) + xlab("Puntuación")+ ylab('Precio (en Euros)')



p1=ggplot(data=df_final) + geom_boxplot(aes(x=Air_conditioning,y=precio_euros,fill=Air_conditioning)) + theme (axis.title.y = element_blank()) + xlab("Aire Acondicionado")

p3=ggplot(data=df_final) + geom_boxplot(aes(x=Wifi,y=precio_euros,fill=Wifi)) + theme (axis.title.y = element_blank()) + xlab("WiFi")
p4=ggplot(data=df_final) + geom_boxplot(aes(x=Breakfast,y=precio_euros,fill=Breakfast)) + theme (axis.title.y = element_blank()) + xlab("Desayuno")
p5=ggplot(data=df_final) + geom_boxplot(aes(x=TV,y=precio_euros,fill=TV)) + theme (axis.title.y = element_blank()) + xlab("Televisión")

p7=ggplot(data=df_final) + geom_boxplot(aes(x=Pets_allowed,y=precio_euros,fill=Pets_allowed)) + theme (axis.title.y = element_blank()) + xlab("Admite Mascotas")
p8=ggplot(data=df_final) + geom_boxplot(aes(x=check_in_24_hs,y=precio_euros,fill=check_in_24_hs)) + theme (axis.title.y = element_blank()) + xlab("Check-In 24hs")


#p3=ggplot(data=df_final) + geom_point(aes(x=cuello,y=precio_euros),size=0.25) + theme (axis.title.y = element_blank())
#p4=ggplot(data=df_final) + geom_point(aes(x=pecho,y=precio_euros),size=0.25) + theme (axis.title.y = element_blank())
#p5=ggplot(data=df_final) + geom_point(aes(x=abdomen,y=precio_euros),size=0.25) + theme (axis.title.y = element_blank())

p6=ggplot(data=df_final) + geom_boxplot(aes(x=distritos,y=precio_euros,fill=distritos)) + theme (axis.title.y = element_blank()) + xlab("Distritos")

(p1+p3+p4+p5+p7+p8)/p6

p5




```

De los anteriores gráficos lo primero que se puede apreciar es que hay muchos datos atípicos, situación en la que nos enfocaremos con profundidad más adelante.
Además podríamos decir que existe diferencia entre el precio de los apartamentos dependiendo de si cuentan o no con aire acondicionado, pero adicional de lo ya mencionado no se puede interpretar con seguridad mucho más debido a que muchas de las cajas se solapan entre si. Esto se puede contemplar bien en el último grafico, el cual toma como variable explicativa a los distritos, en este, todas las cajas tienen aproximadamente las mismas alturas además de las misma mediana, lo que si se puede observar que cambia distrito a distrito es la varianza, siendo la del distrito Sant Andreu la menor de todas.

#SELECCIÓN DE VARIABLES

k=ncol(airbnb_barcelona)-1
modelos_posibles=2**k-1

hay 16383 modelos posibles, vamos a aplicar los procedimientos de hipotesis para
llegar al mejor modelo

```{r }
  
# Definimos la primer versión del modelo

mod0 <- lm(precio_euros ~  distritos + tipo_habitacion+personas+ banios+ habitaciones+camas+estancia_min+puntuacion+TV+Wifi+Air_conditioning+Elevator+Breakfast+Pets_allowed+Pool+Patio_or_balcony+check_in_24_hs+Smart_lock, data=df_final)

#para "vichar"
Anova(mod0)
#summary(mod0)

```


## Diagnóstico

## Multicolinealidad

```{r}
library(car)
vif(mod0)

#si el VIF es alto la variable es comb lineal de las demás, gatos2, ratones tienen VIF altos (>5)

## VER SCRIPTS DE CLASE

```


## Homosedasticidad

```{r}

res_ext<-rstudent(mod0) #residuos
res_int<-rstandard(mod0) #residuos



yhat<-fitted(mod0) #ygorro
#grafico

df_final$predichos <- yhat #agrego los residuos a la tabla
df_final$residuos <- res_ext #agrego los ygorro a la tabla
df_final$residuos_int <- res_int #agrego los ygorro a la tabla

ggplot(df_final, aes(x = predichos , y = residuos)) +
  geom_point() +
  geom_hline(yintercept = 0)


#Test de Bush-Pagan
#3
install.packages("skedastic")
library(skedastic)
breusch_pagan(mod0)

#hipotesis nula es que todos tienen la misma varianza, es decir, hay homoscedasticidad, la otra hipotesis es que hay al menos uno que tiene una varianza diferente a sigma cuadrado
#rechazo H0, NO HAY HOMOSEDASTICIDAD, p valor muy chico.


#4
# histogramas
hist(rstudent(mod0)) #OJO es sensible al tamaño de las barras (bins) por lo que se puede interpretar de diferentes formas
#Q-Q plot
qqPlot(res)
plot(density(df_final$residuos))


```


## Normalidad

```{r}


ggplot(data = df_final, aes(sample = residuos_int)) +
  stat_qq_band(fill = 2) +
  stat_qq_line(col = 2) +
  stat_qq_point() +
  xlab("Cuantiles teoricos")+
  ylab("Cuantiles empiricos")

#PREGUNTA: ¿Por que no corre? ¿Otras opciones?
shapiro.test(df_final$residuos_int)


```



```{r, echo=FALSE}
#PUNTO 6 TALLER
#distritos + tipo_habitacion+personas+ banios+ habitaciones+camas+estancia_min+puntuacion+TV+Wifi+Air_conditioning+Elevator+Breakfast+Pets_allowed+Pool+Patio_or_balcony+check_in_24_hs+Smart_lock

#PREGUNTAR: CONFIRMAR CON EL PROFE SI SIRVE SOLO PARA VARIABLES CUALITATIVAS
crPlot(mod0,"distritos")
crPlot(mod0,"tipo_habitacion")
crPlot(mod0,"habitaciones")
crPlot(mod0,"estancia_min")


```


## Atípicos

```{r, echo=FALSE}

#si hay observaciones influyentes, en el grafico de leverage no se ve, solo se ve ruido, 
#pero en el grafico de cook los que están por arriba de la linea roja son influyentes.

# medidas de influencia
h_i <- influence(mod0)$hat
D_i <- cooks.distance(mod0)
df <- data.frame(i = 1:nrow(df_final),
                 h_i = h_i,
                 D_i = D_i)

#PREGUNTAR: N TIENE QUE SER EL TAMAÑO DE DF? O ES 50 FIJO?

n=nrow(df_final)

ggplot(df, aes(x = i, y = D_i)) +
  geom_point() +
  geom_segment(aes(x = i, xend = i, y = 0, yend = D_i)) +
  xlab('') +
  ylab(expression(D[i])) +
  geom_abline(slope = 0, intercept = 4/50, col = 2, linetype = 'dashed')



# SELECCIONAMOS TOP 50 DE ATÍPICOS
# IR SACANDO DE A POCOS POR SI APARECEN NUEVOS ATIPICOS Y VOLVER A CALCULAR

a = df %>% filter(D_i>(4/50))%>% arrange(desc(D_i)) %>% head(50) %>% pull(i)

## SACAR LOS ATIPICOS CON ESTE "-"


df_final[-a,] ##DATA FRAME FINAL SIN ATIPICOS.


# DEFINIR SI LO DEJAMOS
# leverage
ggplot(df, aes(x = i, y = h_i)) +
  geom_point() +
  geom_segment(aes(x = i, xend = i, y = 0, yend = h_i)) +
  xlab('') +
  ylab(expression(h[i])) +
  geom_abline(slope = 0, intercept = 2*5/50, col = 2, linetype = 'dashed')



```



## Selección del mejor modelo

```{r}


coef(mod0)
summary(mod0)

#CUAL ES LA LIBRERIA??
#forward
modF <- forward(mod0, alpha = 0.05)
length(coef(modF))  # parametros
summary(modF)

# backward
modB <- backward(mod0, alpha = 0.01)
length(coef(modB))  # parametros
summary(modB)

# stepwise
modS <- stepWise(mod0, alpha.enter = 0.04, alpha.remove=0.05)
length(coef(modS))  # parametros
summary(modS)

#COMPARAMOS POR AIC, BIC O R2 AJUSTADO PARA VER CUAL ES EL MEJOR

#que paquete se usaba para ver la tabla con AIC BIC
install.packages("HH")
library(HH)
summaryHH(modF)
summaryHH(modB)

help(anova)
summaryHH(modS)
```

