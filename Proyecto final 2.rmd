---
nocite: '@*'
output:
  pdf_document: 
    latex_engine: xelatex
  bookdown::pdf_document2:
    fig_caption: yes
---

\thispagestyle{empty} 
\begin {center}


UNIVERSIDAD DE LA REPÚBLICA

Facultad de Ciencias Económicas y de Administración

Licenciatura en Estadística

\vspace{4.5 cm}


\textbf{\large  Análisis explicativo del precio de apartamentos publicados en Airbnb de Barcelona}


\vspace{1.5 cm}

\textbf{Viscailuz, Luciana       Miranda, Germán}\\
\textbf{Junio 2024}


\end{center}


\vspace{3.5cm}

\begin{center}
\textbf{Trabajo final de Modelos Lineales}\\
\vspace{1.0 cm}

\end{center}

\newpage

\renewcommand{\contentsname}{Índice}

\tableofcontents


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\newpage 
 
# Introducción

Airbnb es una compañía dedicada a la oferta de alojamientos de carácter vacacional en muchos de los países del mundo. Esta funciona a partir de un programa digital donde los anfitriones pueden publicar sus propiedades para que los clientes puedan verlas y elegir el alojamiento que más se adapte a sus necesidades. 


En este proyecto se trabajó con algunas de las propiedades publidcadas en esta plataforma en la ciudad Barcelona, España. Inicialmente, nuestra motivación del proyecto fue poder estimar el precio (en euros) de diferentes apartamentos según las características de cada uno. Para realizar lo mencionado se trabajó con los datos de Airbnb Barcelona, donde se tenía el registro de más de 16.000 apartamentos de dicha ciudad. 

La información con la que se contaba era buena pero excesiva, lo que llevó a que algunos datos fueran redundantes, por lo cual una parte importante de este proyecto fue la inicial, donde se realizó una limpieza de datos para así disponer de información que permita realizar una buena estimación e interpretación de los datos. 

Finalmente, el trabajo e interpretación de los datos, tanto sobre como actúan entre si y sus diversos efectos sobre la variable de interés fueron los que guiaron y generaron el interés en este proyecto provocando que el paso a paso sea tan importante como el resultado final.  

  

```{r ,echo=FALSE,warning=FALSE,include=FALSE}
library(here)
library(readxl)
library(tidyverse)
library(ggplot2)
library(visdat)
library(patchwork)
library(car)
library(qqplotr)
library(skedastic)
library(faraway)
```


```{r}
df = read_excel(here("airbnb_barcelona_v2.xlsx"))

head(df)
summary(df)
```



## Los datos

Como se mencionó anteriormente, se disponía de la información de 16.761 apartamentos de Barcelona, donde se nombraban las características que los huéspedes toman en cuenta al momento de elegir su hospedaje y por lo tanto podrían llegar a incidir en su precio, entre estas se destacaba, ubicación, cantidad de camas y baños, cuantas personas se aceptaban, entre otras. 

Habían variables cuantitativas pero la mayoría eran cualitativas, e incluso se pasaron a factor algunas de las cuantitativas para su mejor interpretación. 

La información de código postal y barrio se decidió resumirla en una variable llamada distrito la cual agrupó los 73 barrios de Barcelona en 10 distritos.  

Se decidió prescindir de la latitud y longitud de cada apartamento como de algunas variables que se encontraban dentro de la variable amenities, tomando en cuenta finalmente las diez más #importantes. 

Se definieron dos nuevas variables, "grupo_habitacion" y "grupo_banios", donde se agrupan la cantidad de habitaciones y baños respectivamente, para así disminuir la cantidad de categorías de cada variable.

Del total de observaciones se operó con 12.848 debido a que las restantes contaban con datos faltantes.   

Finalizada la limpieza y organización de datos se pudo comenzar a trabajar con ellos. 



```{r}
df%>%vis_miss()

df= df %>% select(barrio,
                  tipo_habitacion,
                  personas,
                  banios,
                  habitaciones,
                  camas,
                  precio_euros,	
                  estancia_min,	
                  puntuacion,	 
                  TV,	 
                  Wifi,	
                  Air_conditioning,	
                  Elevator,	
                  Breakfast,	
                  Pets_allowed,	
                  Patio_or_balcony,	
                  check_in_24_hs
                 )%>% filter(is.na(puntuacion)==FALSE,
                                        is.na(barrio)==FALSE,
                                        is.na(banios)==FALSE,
                                        is.na(habitaciones)==FALSE,
                                        is.na(camas)==FALSE
                                        )
            

df%>%vis_miss()

distritos<-character(length(nrow(df)))
  
for (i in seq_along(df$barrio)) {
    if (df$barrio[i] == "Sant Marta"|| 
               df$barrio[i] == "La Guineueta - Canyelles"|| 
               df$barrio[i] == "La Prosperitat"|| 
               df$barrio[i] == "Nou Barris"|| 
               df$barrio[i] == "Porta"|| 
               df$barrio[i] == "Trinitat Nova"|| 
               df$barrio[i] == "Turo de la Peira - Can Peguera"|| 
               df$barrio[i] == "Verdum - Los Roquetes"|| 
               df$barrio[i] == "Vilapicina i la Torre Llobeta") {
      distritos[i] <- "Nou Barris"
    } else if (df$barrio[i]=='La Sagrada Familia' || 
               df$barrio[i] == "Eixample" || 
               df$barrio[i] == "L'Antiga Esquerra de l'Eixample" || 
               df$barrio[i] == "Sant Antoni" || 
               df$barrio[i] == "Dreta de l'Eixample" || 
               df$barrio[i] == "La Nova Esquerra de l'Eixample" || 
               df$barrio[i] == "el Fort Pienc") {
      distritos[i] <- "L'Eixample"
    } else if (df$barrio[i] == "Vila de Gracia" || 
               df$barrio[i] == "Camp d'en Grassot i Gracia Nova" || 
               df$barrio[i] == "Gracia" || 
               df$barrio[i] == "El Coll" || 
               df$barrio[i] == "La Salut" || 
               df$barrio[i] == "Vallcarca i els Penitents") {
      distritos[i] <- "Gracia"
    } else if (df$barrio[i] == "Horta-Guinarda" ||
               df$barrio[i] == "Can Baro" ||
               df$barrio[i] == "Carmel" ||
               df$barrio[i] == "El Baix Guinardo"||
               df$barrio[i] == "Guinarda" ||
               df$barrio[i] == "Horta"||
               df$barrio[i] == "La Font d'en Fargues"||
               df$barrio[i] == "La Teixonera"||
               df$barrio[i] == "La Vall d'Hebron"||
               df$barrio[i] == "Montbau"||
               df$barrio[i] == "Sant Geni­s dels Agudells") {
      distritos[i] <- "Horta"
    } else if (df$barrio[i] == "Les Corts"|| 
               df$barrio[i] == "La Maternitat i Sant Ramon"|| 
               df$barrio[i] == "Pedralbes") {
      distritos[i] <- "Les Corts"
    } else if (df$barrio[i] == "El Gotic" || 
               df$barrio[i] == "La Barceloneta" || 
               df$barrio[i] == "Ciutat Vella" || 
               df$barrio[i] == "El Raval" || 
               df$barrio[i] == "Sant Pere/Santa Caterina" || 
               df$barrio[i] == "El Born") {
      distritos[i] <- "Ciutat Vella"
    } else if (df$barrio[i] == "El Poble-sec" || 
               df$barrio[i] == "Sants-Montjuic") {
      distritos[i] <- "Sants-Montjuic"
    } else if (df$barrio[i] == "El Clot" || 
               df$barrio[i] == "El Besos i el Maresme" || 
               df$barrio[i] == "El Camp de l'Arpa del Clot"||
               df$barrio[i] == "El Poblenou"||
               df$barrio[i] == "La Vila Olimpica"||
               df$barrio[i] == "Diagonal Mar - La Mar Bella"||
               df$barrio[i] == "Glaries - El Parc"||
               df$barrio[i] == "La Verneda i La Pau"||
               df$barrio[i] == "Provencals del Poblenou"||
               df$barrio[i] == "Sant Marta­ de Provencals"
               ) {
      distritos[i] <- "Sant Martí"
    } else if (df$barrio[i] == "Sant Gervasi - Galvany"||
               df$barrio[i] == "El Putget i Farro"||
               df$barrio[i] == "Les Tres Torres"||
               df$barrio[i] == "Sant Gervasi - la Bonanova"||
               df$barrio[i] == "Sarria"||
               df$barrio[i] == "Sarria-Sant Gervasi") {
      distritos[i] <- "Sarriá"
    } else if (df$barrio[i] == "El Bon Pastor" ||
               df$barrio[i] == "El Congres i els Indians"||
               df$barrio[i] == "La Sagrera"||
               df$barrio[i] == "La Trinitat Vella"||
               df$barrio[i] == "Navas"||
               df$barrio[i] == "Sant Andreu"||
               df$barrio[i] == "Sant Andreu de Palomar") {
      distritos[i] <- "Sant Andreau"
  }
}
df$distritos <- distritos

#Pasamos las variables a factor y definimos dos nuevas variables "grupo_habitacion" y "grupo_banios" que "achican" las categorías de habitación y baños respectivamente.

df_final= df%>% mutate(tipo_habitacion=as.factor(tipo_habitacion),
                       camas=as.factor(camas),
                       distritos=as.factor(distritos),
                       Wifi=as.factor(Wifi),
                       TV=as.factor(TV),	 
                       Air_conditioning=as.factor(Air_conditioning),	
                       Elevator=as.factor(Elevator),	
                       Breakfast=as.factor(Breakfast),	
                       Pets_allowed=as.factor(Pets_allowed),	
                       Patio_or_balcony=as.factor(Patio_or_balcony),	
                       check_in_24_hs=as.factor(check_in_24_hs),	
                       grupo_habitacion=as.factor(ifelse(habitaciones>=0 & habitaciones<3,'Chica',ifelse(habitaciones>=3 & habitaciones<6,'Mediana','Grande'))),
                       grupo_banios=as.factor(ifelse(banios>=0 & banios<2,'Pocos',ifelse(banios>=2 & banios<5,'Intermedio','Muchos')))
             )

df_final


```





# Análisis exploratorio

Como parte de la estadística descriptiva se crearon gráficos donde se relacionan cada una de las variables explicativas con la variable de respuesta (precio en euros), estos graficos permiten obtener interpretaciones de las diferentes relaciones, pero es muy importante destacar que las interpretaciones obtenidas son parciales, debido a que a diferencia del modelo, en cada uno de los gráficos se representa el efecto de una variable sin tomar en cuenta las demás.

```{r, echo=FALSE,results='asis',fig.cap="Histograma de la variable de respuesta Precio", results='asis'}

#HAY DOS HISTOGRAMAS, CON CUAL NOS QUEDAMOS??? #RESOLVER

h1=df%>%ggplot()+geom_histogram(aes(x=precio_euros)) +theme_bw() + theme (axis.title.y = element_blank()) + labs(x="Precio (en Euros)")
# Se "normalizan" más los datos con Log(Precio_euros)
h2=df%>%ggplot()+geom_histogram(aes(x=log(precio_euros))) +theme_bw()+ theme (axis.title.y = element_blank()) + labs(x="Log(Precio)")

h1/h2

```



```{r echo=FALSE, warning=FALSE, results='asis',fig.cap="Dispersión de Precio (en euros) por Distrito", results='asis'}

ggplot(data=df_final) + geom_boxplot(aes(x=distritos,y=log(precio_euros),fill=distritos))+labs(y="Log(Precio)",x="Distritos",fill="Distritos") +theme_bw()  + theme (axis.title.x = element_blank(),axis.text.x = element_text(angle = 45,vjust = 0.5)) 

```


```{r echo=FALSE, warning==FALSE,fig.cap="Dispersión de Precio (en euros) según la puntuación, por tipo de alojamiento", results='asis'}

ggplot(data=df_final) + geom_point(aes(x=puntuacion,y=precio_euros),size=1) + xlab("Puntuación")+ ylab('Precio (en Euros)') +facet_wrap(~tipo_habitacion) +theme_bw()

ggplot(data=df_final) + geom_point(aes(x=puntuacion,y=precio_euros),size=1) + xlab("Puntuación")+ ylab('Precio (en Euros)')  +theme_bw()


```


```{r echo=FALSE, eval=FALSE}

#ELIMINAR?

#ggplot(data=df_final) + geom_boxplot(aes(x=tipo_habitacion,y=precio_euros,fill=tipo_habitacion)) + ylab('Precio (en Euros)')+ xlab("Tipo de Habitación")

#p2=ggplot(data=df_final) + geom_point(aes(x=personas,y=precio_euros),size=0.25) + theme (axis.title.y = element_blank())

#p3=ggplot(data=df_final) + geom_point(aes(x=estancia_min,y=precio_euros),size=0.25) + theme (axis.title.y = element_blank())




p1=ggplot(data=df_final) + geom_boxplot(aes(x=Air_conditioning,y=precio_euros,fill=Air_conditioning)) + theme (axis.title.y = element_blank()) + xlab("Aire Acondicionado")

p3=ggplot(data=df_final) + geom_boxplot(aes(x=Wifi,y=precio_euros,fill=Wifi)) + theme (axis.title.y = element_blank()) + xlab("WiFi")
p4=ggplot(data=df_final) + geom_boxplot(aes(x=Breakfast,y=precio_euros,fill=Breakfast)) + theme (axis.title.y = element_blank()) + xlab("Desayuno")
p5=ggplot(data=df_final) + geom_boxplot(aes(x=TV,y=precio_euros,fill=TV)) + theme (axis.title.y = element_blank()) + xlab("Televisión")

p7=ggplot(data=df_final) + geom_boxplot(aes(x=Pets_allowed,y=precio_euros,fill=Pets_allowed)) + theme (axis.title.y = element_blank()) + xlab("Admite Mascotas")
p8=ggplot(data=df_final) + geom_boxplot(aes(x=check_in_24_hs,y=precio_euros,fill=check_in_24_hs)) + theme (axis.title.y = element_blank()) + xlab("Check-In 24hs")


#p3=ggplot(data=df_final) + geom_point(aes(x=cuello,y=precio_euros),size=0.25) + theme (axis.title.y = element_blank())
#p4=ggplot(data=df_final) + geom_point(aes(x=pecho,y=precio_euros),size=0.25) + theme (axis.title.y = element_blank())
#p5=ggplot(data=df_final) + geom_point(aes(x=abdomen,y=precio_euros),size=0.25) + theme (axis.title.y = element_blank())

p6=ggplot(data=df_final) + geom_boxplot(aes(x=distritos,y=log(precio_euros),fill=distritos)) + theme (axis.title.y = element_blank(),axis.text.x = element_text(angle = 45,vjust = 0.5)) + xlab("Distritos")

##(p1+p3+p4+p5+p7+p8)/p6


```

#RESOLVER, QUE GRÁFICOS VAMOS A HACER???: 
De los anteriores gráficos lo primero que se puede apreciar es que hay muchos datos atípicos, situación en la que nos enfocaremos con profundidad más adelante.
Además podríamos decir que existe diferencia entre el precio de los apartamentos dependiendo de si cuentan o no con aire acondicionado, pero adicional de lo ya mencionado no se puede interpretar con seguridad mucho más debido a que muchas de las cajas se solapan entre si. Esto se puede contemplar bien en el último grafico, el cual toma como variable explicativa a los distritos, en este, todas las cajas tienen aproximadamente las mismas alturas además de las misma mediana, lo que si se puede observar que cambia distrito a distrito es la varianza, siendo la del distrito Sant Andreu la menor de todas.


# Metodología

## Selección de variables


k=ncol(airbnb_barcelona)-1
modelos_posibles=2**k-1

hay 16383 modelos posibles, vamos a aplicar los procedimientos de hipotesis para
llegar al mejor modelo

```{r }
  
# Definimos la primer versión del modelo

mod0 <- lm(log(precio_euros) ~  distritos + tipo_habitacion+personas+ grupo_banios+ grupo_habitacion+estancia_min+puntuacion+TV+Wifi+Air_conditioning+Elevator+Breakfast+Pets_allowed+Patio_or_balcony+check_in_24_hs, data=df_final)

#para "vichar"
Anova(mod0)
summary(mod0)

```


## Diagnóstico

Luego de la limpieza de datos y estadística descriptiva se comenzó la etapa de diagnótico, esta etapa es imprescindible debido a que el cumplimiento de todos los supuestos sobre el modelo es el que permite afirmar que las inferencias realizadas son validas.
Entre estos supuestos se encuentran:

Multicolinealidad: en está prueba se busca que ninguna de las columnas de la matriz X sea "casi" combinación lineal de las demás. Cuando esto si sucede el número de condición aumenta, lo que lleva finalmente a que la inversa de X'X sea inestable. Esta inestabilidad es la que finalmente se busca evitar. #RESPUESTA A LA PREGUNTA: VOLVER A CALCUAR VIF Y NÚMERO DE CONDICIÓN LUEGO DE HACERLE TODOS LOS ARREGLOS AL MODELO Y VER SI LOS RESULTADOS SE PUEDEN INTERPRETAR, EN EL CASO CONTRARIO EXPLICAR POR QUÉ NO TIENE SENTIDO INTERPETAR #(SI NO SE PUEDEN INTERPRETAR PREGUNTAR AL PROFE SI LA "RAZÓN" ESTÁ BIEN)

Linealidad: este supuesto se basa en la linealidad de la variable precio_euros y cada una de las variables explicativas, si en el modelo no hay linealidad se presentarán probelmas de correlación entre los residuos y variabilidad de los mismos. Para verificar el cumplimiento de este supuesto se realizó un análisis gráfico entre los Yˆ y εˆ, en el cual se busca no encontrar patrones. #NO NOS PREOCUPEMOS

Homoscedasticidad: se busca que el modelo sea homoscedastico, es decir, que la varianza de todos los residuos sea constante,se va a entender esto como que la varianza no depende de ninguna de las variables explicativas. Esta prueba se verá mediante gráficos que relaciona cada variable explicativa con la de respuesta y a partir de una prueba de hipótesis donde buscamos no rechazar la hipótesis nula. #EL PROFE DIJO QUE AL SER TANTAS VARIABLES (TODO) SIEMPRE VA A SER SIGNIFICATIVO, PODEMOS AGREGARLO POR ESCRITO

Normalidad: se refiere a que los residuos deben tener una distribución normal, este supuesto es muy importante debido a que es el que luego permite realizar inferencias. Sin embargo en los modelos donde el tamaño de muestra es grande, como en este caso, la falta de normalidad de los residuos no generan repercusiones. #AL SER TANTAS OBSERVACIONES SON "ROBUSTAS" A LA NORMALIDAD (ALGO ASÍ DIJO EL PROFE)

En las siguientes lineas del script se pusieron a prueba cada uno de los supuestos antes mencionados.



### Multicolinealidad

```{r echo=FALSE,results='asis'}
library(car)

X <- model.matrix(mod0)
XX <-t(X)%*%X
eigen_result <- eigen(XX) #valores y vectores propios de XX

# Obtener los valores propios
valores_propios <- eigen_result$values

#data.frame(Valores_Propios=valores_propios) 

#RESOLVER: ¿LOS MOSTRAMOS?
##knitr::kable(valores_propios,col.names = "Valores Propios") %>%print()
##print(valores_propios) 

#Número de condición ¿LO MOSTRAMOS?
kA <- sqrt(max(valores_propios)/min(valores_propios))
print(kA)

```

El número de condición es muy alto, lo que nos dice que hay problemas de multicolinealidad.


```{r}

vif(mod0)

## VER SCRIPTS DE CLASE

```
mirando los VIF de cada una de las variables todos son mayores a 1 pero ninguno mayor a 5, por lo cual no se podría determinar cual es la variable causante de la multicolinealidad.
importante recordar que no estamos estimando el precio en euros, sino que el logaritmo del precio en euros


### Linelidad 

#RESOLVER, EL SUPUESTO SE VERIFICA ASÍ??

```{r echo=FALSE,fig.cap="Gráfico de puntos de los residuos del modelo en función de los valores predichos", results='asis' }
res_ext<-rstudent(mod0) #residuos
res_int<-rstandard(mod0) #residuos
yhat<-fitted(mod0) #ygorro
#grafico

df_final$predichos <- yhat #agrego los residuos a la tabla
df_final$residuos <- res_ext #agrego los ygorro a la tabla
df_final$residuos_int <- res_int #agrego los ygorro a la tabla

ggplot(df_final, aes(x = predichos , y = residuos)) +
  geom_point(size=1) +  geom_hline(yintercept = 0) + labs(y="Residuos",x="Predichos") +theme_bw() 
#en el gráfico se puede ver que la mayoría de los puntos se encuentran "agrupados", (Eso cuenta como un patrón?) #RESOLVER

```


### Homoscedasticidad

```{r}

#install.packages("skedastic")
df_bp=data.frame(breusch_pagan(mod0))

knitr::kable(df_bp)%>%print()
#buscamos NO rechazar H0, el p-valor es 1.11e-129, muy chico, por lo cual se rechaza H0, debemos intentar subir el p-valor.
#H0 nos dice que los errores son homoscedasticos

#hipotesis nula es que todos tienen la misma varianza, es decir, hay homoscedasticidad, la otra hipotesis es que hay al menos uno que tiene una varianza diferente a sigma cuadrado
#rechazo H0, NO HAY HOMOSEDASTICIDAD, p valor muy chico.


```

### Normalidad

```{r}

# histogramas
hist(rstudent(mod0)) #OJO es sensible al tamaño de las barras (bins) por lo que se puede interpretar de diferentes formas
#nos gustaría ver que tenga la forma de una campana simetrica, en este caso tiene más o menos la forma, importante tomar en cuenta que el tamaño de los bins influye muchísimo en la forma del histograma.

#Q-Q plot
qqPlot(res_ext)
plot(density(df_final$residuos))
#los puntos no están sobre la recta, nos hay normalidad
```

```{r, eval=FALSE}

ggplot(data = df_final, aes(sample = residuos_int)) +
  stat_qq_band(fill = 2) +
  stat_qq_line(col = 2) +
  stat_qq_point() +
  xlab("Cuantiles teoricos")+
  ylab("Cuantiles empiricos")

#DATOS FUERA DE LA BANDA. SE PUEDE VER QUE NO HAY NORMALIDAD.
#Randomize

#NO FUNCIONA #RESOLVER
ks.test(df_final$residuos_int)

```



```{r, echo=FALSE}
#PUNTO 6 TALLER
#distritos + tipo_habitacion+personas+ banios+ habitaciones+camas+estancia_min+puntuacion+TV+Wifi+Air_conditioning+Elevator+Breakfast+Pets_allowed+Pool+Patio_or_balcony+check_in_24_hs+Smart_lock

#QUE SIGNIFICAN ESTOS GRÁFICOS? ES PARA EL SUPUESTO DE LINEALIDAD? ES NECESARIO HACERLOS???#RESOLVER
crPlot(mod0,"distritos")
crPlot(mod0,"tipo_habitacion")
crPlot(mod0,"grupo_habitacion")
crPlot(mod0,"estancia_min")


```


### Atípicos

```{r, echo=FALSE}

#si hay observaciones influyentes, en el grafico de leverage no se ve, solo se ve ruido, 
#pero en el grafico de cook los que están por arriba de la linea roja son influyentes.

# medidas de influencia
h_i <- influence(mod0)$hat
D_i <- cooks.distance(mod0)

df <- data.frame(i = 1:nrow(df_final),
                 h_i = h_i,
                 D_i = D_i)

#RESOLVER: ¿Este gráfico está asociado al id de cada observación correctamente?

ggplot(df, aes(x = i, y = D_i)) +
  geom_point() +
  geom_segment(aes(x = i, xend = i, y = 0, yend = D_i)) +
  xlab('') +
  ylab(expression(D[i])) +
  geom_abline(slope = 0, intercept = 4/500, col = 2, linetype = 'dashed')

```


```{r, echo=FALSE}


a = df %>% filter(D_i>(4/500))%>% arrange(desc(D_i)) %>% pull(i)

# valor de 50 a "gusto"

## SACAR LOS ATIPICOS CON ESTE "-"

df_final[a,]

df_2=df_final[-a,] ##DATA FRAME FINAL SIN ATIPICOS.


# RESOLVER: DEFINIR SI LO DEJAMOS
# leverage
ggplot(df, aes(x = i, y = h_i)) +
  geom_point() +
  geom_segment(aes(x = i, xend = i, y = 0, yend = h_i)) +
  xlab('') +
  ylab(expression(h[i])) +
  geom_abline(slope = 0, intercept = 2*5/50, col = 2, linetype = 'dashed')



```


```{r}
mod1 <- lm(log(precio_euros) ~  distritos + tipo_habitacion+personas+ grupo_banios+ grupo_habitacion+estancia_min+puntuacion+TV+Wifi+Air_conditioning+Elevator+Breakfast+Pets_allowed+Patio_or_balcony+check_in_24_hs, data=df_2)

#para "vichar"
Anova(mod1)
summary(mod1)

# p-valor de grupo_habitación alto, ¿está relacionado con el grupo de referencia? ¿Habrá que sacar la variable?



mod2= lm(log(precio_euros) ~  distritos + tipo_habitacion+personas+ grupo_banios+estancia_min+puntuacion+TV+Wifi+Air_conditioning+Elevator+Breakfast+Pets_allowed+Patio_or_balcony+check_in_24_hs, data=df_2)
Anova(mod2)
summary(mod2)
# si sacamos la variable, el r2 no cambia.


```





A partir de la etapa del diagnóstico se llegó a diferentes conclusiones sobre que hay que cambiar en el modelo para que este sea lo mejor posible, se comenzó evaluando el supuesto de multicolinealidad, para esto se calculó el número de condición, el cual dió 2792.348, es decir, hay problemas de multicolinealidad. Luego se calculó el VIF para cada una de las variables explicativas, todas tenían un VIF mayor a 1 pero menor a 5, por lo cual, no se pudo determinar cual es la variable que generó el problema del cumplimiento de este supuesto. De igual forma, esto no provocó grandes problemas debido a que se trabajó con un modelo con muchas variables cualitativas, lo cual hace que la evaluación de este supuesto no tenga mucho sentido. 

Luego se siguió con el supuesto de linelidad, donde se realizó el grafico entre residuos y predichos. #RESOLVER

Como ya se mencionó, los dos primeros supuestos diagnosticados son importantes pero no tanto para un modelo como el que se presentó, por lo cual se centró la atención en diagnosticar los supuestos restantes, como la homoscedasticidad, donde a partir del test de BREUSCH-PAGAN se pudo observar que en el modelo inicial no se cumplía este supuesto. El p-valor dió muy bajo, lo que provocó que se rechazara H0. Subir dicho p-valor fue unos de los cambios que se realizó en el modelo.

Otro supuesto importante es el de la normalidad, para evaluarlo se realizó un histograma y un QQ-Plot, en el primer gráfico se pudo observar que tenía forma de una campana simétrica, en cambio en el segundo gráfico los puntos se encontraban fuera de la banda, es decir, el primer gráfico dio indicios de que si se cumplia el supuesto de normalidad pero el segundo mostraba que no. Para definir el cumpliento o no del supuesto se realizó la Prueba de Kolmogorov-Smirnov #RESOLVER

Por último se realizó el gráfico de la Distancia de Cook para observar si habían observaciones atípicas. Usualmente en este gráfico se hace la línea roja horizontal al nivel de 4/n, donde n es el número de observaciones, como en este modelo las observaciones son muchas esta linea roja quedaba muy baja, haciendo referencia a que todas las osbervaciones eran atípicas, para poder interpretar mejor esto se decidió que la linea esté en el nivel de 4/300, en ese punto las observaciones atípicas terminan siendo las más diferentes.

A continuación se verán algunos de los cambios realizados en el modelo con respecto al cumplimiento de los principales supuestos junto con los nuevos resultados.


  

```{r ,eval=FALSE}


coef(mod0)
summary(mod0)

#CUAL ES LA LIBRERIA??
#forward
library(mixlm)
modF <- forward(mod0, alpha = 0.05)
length(coef(modF))  # parametros
summary(modF)

# backward
modB <- backward(mod0, alpha = 0.01)
length(coef(modB))  # parametros
summary(modB)

# stepwise
modS <- stepWise(mod0, alpha.enter = 0.04, alpha.remove=0.05)
length(coef(modS))  # parametros
summary(modS)

#COMPARAMOS POR AIC, BIC O R2 AJUSTADO PARA VER CUAL ES EL MEJOR

#que paquete se usaba para ver la tabla con AIC BIC
install.packages("HH")
library(HH)
summaryHH(modF)
summaryHH(modB)

help(anova)
summaryHH(modS)
```

# Resultados

# Conclusiones

# Bibliografía


